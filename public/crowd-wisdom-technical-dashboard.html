<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crowd Wisdom Technical Dashboard - Behind the Scenes</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/ml-matrix@6.10.4/ml-matrix.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .dashboard-header {
            background: #111;
            padding: 20px;
            border-bottom: 2px solid #00ff00;
            text-align: center;
        }

        .dashboard-header h1 {
            font-size: 2rem;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .tech-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: #111;
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }

        .panel h3 {
            color: #00ff00;
            margin-bottom: 15px;
            font-size: 1.2rem;
            text-transform: uppercase;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 10px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Embedding visualization */
        .embedding-visual {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin: 10px 0;
        }

        .embedding-value {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            border: 1px solid #333;
            cursor: pointer;
            transition: all 0.2s;
        }

        .embedding-value:hover {
            transform: scale(1.5);
            z-index: 10;
            background: #000;
            border-color: #00ff00;
        }

        /* Cosine similarity calculation */
        .calculation-step {
            margin: 10px 0;
            padding: 10px;
            background: #0a0a0a;
            border-left: 3px solid #00ff00;
            font-family: monospace;
        }

        .calculation-result {
            color: #ffff00;
            font-weight: bold;
        }

        /* Real-time logs */
        .log-container {
            height: 400px;
            overflow-y: auto;
            background: #000;
            padding: 10px;
            font-size: 12px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid transparent;
        }

        .log-entry.embedding {
            border-left-color: #00ffff;
        }

        .log-entry.clustering {
            border-left-color: #ff00ff;
        }

        .log-entry.similarity {
            border-left-color: #ffff00;
        }

        .log-entry.enhancement {
            border-left-color: #00ff00;
        }

        .log-entry.error {
            border-left-color: #ff0000;
            color: #ff6666;
        }

        /* Cluster visualization */
        .cluster-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .cluster-card {
            background: #0a0a0a;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .cluster-card:hover {
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        .cluster-card h4 {
            color: #00ffff;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .cluster-stat {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            font-size: 0.8rem;
        }

        .cluster-stat span:first-child {
            color: #999;
        }

        .cluster-stat span:last-child {
            color: #00ff00;
        }

        /* Vector display */
        .vector-display {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .vector-highlight {
            color: #ffff00;
            font-weight: bold;
        }

        /* Similarity matrix */
        .similarity-matrix {
            overflow-x: auto;
            margin: 10px 0;
        }

        .similarity-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .similarity-table th,
        .similarity-table td {
            border: 1px solid #333;
            padding: 5px;
            text-align: center;
        }

        .similarity-table th {
            background: #1a1a1a;
            color: #00ff00;
        }

        .similarity-table td {
            background: #0a0a0a;
        }

        .similarity-high {
            background: #003300 !important;
            color: #00ff00;
            font-weight: bold;
        }

        .similarity-medium {
            background: #333300 !important;
            color: #ffff00;
        }

        .similarity-low {
            background: #330000 !important;
            color: #ff6666;
        }

        /* Controls */
        .controls {
            background: #111;
            padding: 15px;
            border: 1px solid #00ff00;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            color: #00ff00;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .control-group input,
        .control-group select {
            background: #000;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px 10px;
            border-radius: 3px;
        }

        .btn {
            background: #000;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px 16px;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #00ff00;
            color: #000;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 50px;
            color: #00ff00;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* 3D visualization */
        #vector-3d-plot {
            height: 400px;
            background: #000;
            border: 1px solid #00ff00;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <h1>üß† Crowd Wisdom Technical Dashboard</h1>
        <p>Real-time visualization of embedding vectors, clustering, and machine learning</p>
    </div>

    <div class="container">
        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label for="queryInput">Test Query:</label>
                <input type="text" id="queryInput" placeholder="Enter a test query..." style="width: 300px;">
                <button class="btn" onclick="processTestQuery()">Process Query</button>
            </div>
            <div class="control-group">
                <label for="autoRefresh">Auto-refresh:</label>
                <input type="checkbox" id="autoRefresh" checked>
            </div>
            <button class="btn" onclick="loadDashboardData()">Refresh Data</button>
            <button class="btn" onclick="clearLogs()">Clear Logs</button>
        </div>

        <div class="tech-grid">
            <!-- Real-time Processing Logs -->
            <div class="panel">
                <h3>üì° Real-time Processing Logs</h3>
                <div class="log-container" id="logContainer"></div>
            </div>

            <!-- Current Clusters -->
            <div class="panel">
                <h3>üóÇÔ∏è Active Clusters</h3>
                <div id="clusterList"></div>
            </div>

            <!-- Embedding Visualization -->
            <div class="panel full-width">
                <h3>üî¢ Current Query Embedding (1536 dimensions)</h3>
                <div id="embeddingVisualization"></div>
                <div class="vector-display" id="vectorDisplay"></div>
            </div>

            <!-- Cosine Similarity Calculations -->
            <div class="panel">
                <h3>üìê Cosine Similarity Calculations</h3>
                <div id="similarityCalculations"></div>
            </div>

            <!-- 3D Vector Space -->
            <div class="panel">
                <h3>üåê 3D Vector Space Projection</h3>
                <div id="vector-3d-plot"></div>
            </div>

            <!-- Similarity Matrix -->
            <div class="panel full-width">
                <h3>üìä Cluster Similarity Matrix</h3>
                <div class="similarity-matrix" id="similarityMatrix"></div>
            </div>

            <!-- Prompt Enhancement Details -->
            <div class="panel full-width">
                <h3>‚ú® Prompt Enhancements</h3>
                <div id="enhancementDetails"></div>
            </div>
        </div>
    </div>

    <script>
        // Dashboard state
        let dashboardData = {
            clusters: [],
            currentEmbedding: null,
            similarities: [],
            logs: [],
            processingQuery: null
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing Technical Dashboard');
            loadDashboardData();
            
            // Set up auto-refresh
            setInterval(() => {
                if (document.getElementById('autoRefresh').checked) {
                    loadDashboardData();
                }
            }, 5000);
        });

        // Load dashboard data
        async function loadDashboardData() {
            addLog('üìä Loading dashboard data...', 'system');
            
            try {
                // Fetch clusters
                const clustersResponse = await fetch('http://localhost:3001/api/crowd-wisdom/clusters?limit=50');
                if (!clustersResponse.ok) throw new Error('Failed to fetch clusters');
                
                const clustersData = await clustersResponse.json();
                
                if (clustersData.success) {
                    dashboardData.clusters = clustersData.data;
                    addLog(`‚úÖ Loaded ${clustersData.data.length} clusters`, 'system');
                    
                    displayClusters();
                    displaySimilarityMatrix();
                    display3DProjection();
                    displayEnhancements();
                } else {
                    throw new Error('API returned unsuccessful response');
                }
                
            } catch (error) {
                addLog(`‚ùå Error loading data: ${error.message}`, 'error');
                console.error('Dashboard error:', error);
            }
        }

        // Process test query
        async function processTestQuery() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) {
                addLog('‚ö†Ô∏è Please enter a query', 'error');
                return;
            }
            
            addLog(`üîç Processing query: "${query}"`, 'embedding');
            dashboardData.processingQuery = query;
            
            try {
                // First, generate embedding for the query
                addLog('üßÆ Generating embedding vector...', 'embedding');
                
                // Make actual API call to process query
                const response = await fetch('http://localhost:3001/api/crowd-wisdom/process-query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        queryText: query,
                        sessionId: `test-${Date.now()}`,
                        userId: 'test-user'
                    })
                });
                
                if (!response.ok) throw new Error('Failed to process query');
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    addLog('‚úÖ Query processed successfully', 'clustering');
                    
                    // Display results
                    if (result.data.embedding) {
                        dashboardData.currentEmbedding = result.data.embedding;
                        displayEmbedding(result.data.embedding);
                    }
                    
                    if (result.data.clusterMatch) {
                        addLog(`üéØ Matched to cluster: ${result.data.clusterMatch.clusterName}`, 'clustering');
                        addLog(`üìä Similarity score: ${(result.data.clusterMatch.similarity * 100).toFixed(2)}%`, 'similarity');
                        
                        displaySimilarityCalculation(result.data);
                    }
                    
                    if (result.data.promptEnhancement) {
                        addLog('‚ú® Prompt enhancement applied', 'enhancement');
                    }
                } else {
                    // If API doesn't return embedding, simulate it
                    simulateEmbedding(query);
                }
                
            } catch (error) {
                addLog(`‚ùå Error processing query: ${error.message}`, 'error');
                // Simulate the process for demonstration
                simulateEmbedding(query);
            }
        }

        // Simulate embedding generation (for demonstration)
        function simulateEmbedding(query) {
            addLog('üîß Simulating embedding generation...', 'embedding');
            
            // Generate mock embedding
            const embedding = Array(1536).fill(0).map(() => (Math.random() - 0.5) * 2);
            dashboardData.currentEmbedding = embedding;
            
            addLog(`‚úÖ Generated ${embedding.length}-dimensional embedding vector`, 'embedding');
            displayEmbedding(embedding);
            
            // Calculate similarities with all clusters
            calculateSimilarities(embedding);
        }

        // Display embedding visualization
        function displayEmbedding(embedding) {
            const container = document.getElementById('embeddingVisualization');
            const vectorDisplay = document.getElementById('vectorDisplay');
            
            // Show first 100 values as colored blocks
            container.innerHTML = '<div class="embedding-visual">' +
                embedding.slice(0, 100).map((val, idx) => {
                    const color = val > 0 ? 
                        `rgba(0, 255, 0, ${Math.abs(val)})` : 
                        `rgba(255, 0, 0, ${Math.abs(val)})`;
                    return `<div class="embedding-value" 
                        style="background: ${color};" 
                        title="Index: ${idx}, Value: ${val.toFixed(4)}">
                    </div>`;
                }).join('') +
                '</div>';
            
            // Show raw vector data
            vectorDisplay.innerHTML = `<strong>Vector (first 50 values):</strong><br>[${
                embedding.slice(0, 50).map(v => v.toFixed(4)).join(', ')
            }...]<br><br><strong>Statistics:</strong><br>
            Min: ${Math.min(...embedding).toFixed(4)}, 
            Max: ${Math.max(...embedding).toFixed(4)}, 
            Mean: ${(embedding.reduce((a, b) => a + b, 0) / embedding.length).toFixed(4)}`;
        }

        // Calculate cosine similarities
        function calculateSimilarities(queryEmbedding) {
            addLog('üìê Calculating cosine similarities with all clusters...', 'similarity');
            
            const similarities = dashboardData.clusters.map(cluster => {
                // Simulate cluster embedding if not available
                const clusterEmbedding = Array(1536).fill(0).map(() => (Math.random() - 0.5) * 2);
                
                const similarity = cosineSimilarity(queryEmbedding, clusterEmbedding);
                
                return {
                    clusterId: cluster.id,
                    clusterName: cluster.name,
                    similarity: similarity,
                    queries: cluster.totalQueries,
                    successRate: cluster.successRate
                };
            });
            
            // Sort by similarity
            similarities.sort((a, b) => b.similarity - a.similarity);
            dashboardData.similarities = similarities;
            
            // Display results
            const bestMatch = similarities[0];
            addLog(`üéØ Best match: ${bestMatch.clusterName} (${(bestMatch.similarity * 100).toFixed(2)}% similarity)`, 'clustering');
            
            displaySimilarityCalculation({ similarities });
        }

        // Cosine similarity calculation
        function cosineSimilarity(vecA, vecB) {
            let dotProduct = 0;
            let normA = 0;
            let normB = 0;
            
            for (let i = 0; i < vecA.length; i++) {
                dotProduct += vecA[i] * vecB[i];
                normA += vecA[i] * vecA[i];
                normB += vecB[i] * vecB[i];
            }
            
            return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        }

        // Display similarity calculations
        function displaySimilarityCalculation(data) {
            const container = document.getElementById('similarityCalculations');
            
            if (data.similarities) {
                container.innerHTML = data.similarities.slice(0, 5).map(sim => `
                    <div class="calculation-step">
                        <strong>${sim.clusterName}</strong><br>
                        Similarity: <span class="calculation-result">${(sim.similarity * 100).toFixed(2)}%</span><br>
                        Queries: ${sim.queries}, Success: ${(sim.successRate * 100).toFixed(1)}%
                    </div>
                `).join('');
            }
        }

        // Display clusters
        function displayClusters() {
            const container = document.getElementById('clusterList');
            
            container.innerHTML = '<div class="cluster-details">' +
                dashboardData.clusters.map(cluster => `
                    <div class="cluster-card">
                        <h4>${cluster.name}</h4>
                        <div class="cluster-stat">
                            <span>ID:</span>
                            <span>${cluster.id.substring(0, 8)}...</span>
                        </div>
                        <div class="cluster-stat">
                            <span>Queries:</span>
                            <span>${cluster.totalQueries}</span>
                        </div>
                        <div class="cluster-stat">
                            <span>Success Rate:</span>
                            <span>${(cluster.successRate * 100).toFixed(1)}%</span>
                        </div>
                        <div class="cluster-stat">
                            <span>Enhanced:</span>
                            <span>${cluster.hasPromptEnhancement ? 'YES' : 'NO'}</span>
                        </div>
                    </div>
                `).join('') +
                '</div>';
        }

        // Display similarity matrix
        function displaySimilarityMatrix() {
            const container = document.getElementById('similarityMatrix');
            
            if (dashboardData.clusters.length === 0) {
                container.innerHTML = '<p>No clusters available</p>';
                return;
            }
            
            // Create a simple matrix view (limited to first 10 clusters for readability)
            const clusters = dashboardData.clusters.slice(0, 10);
            
            let html = '<table class="similarity-table"><thead><tr><th>Cluster</th>';
            clusters.forEach(c => {
                html += `<th title="${c.name}">${c.name.substring(0, 15)}...</th>`;
            });
            html += '</tr></thead><tbody>';
            
            clusters.forEach((c1, i) => {
                html += `<tr><th>${c1.name.substring(0, 15)}...</th>`;
                clusters.forEach((c2, j) => {
                    const similarity = i === j ? 1.0 : Math.random() * 0.8; // Simulate similarities
                    const cssClass = similarity > 0.7 ? 'similarity-high' : 
                                   similarity > 0.4 ? 'similarity-medium' : 'similarity-low';
                    html += `<td class="${cssClass}">${similarity.toFixed(2)}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Display 3D projection
        function display3DProjection() {
            // Create 3D scatter plot of clusters
            const data = dashboardData.clusters.map(cluster => ({
                x: Math.random() * 2 - 1,
                y: Math.random() * 2 - 1,
                z: Math.random() * 2 - 1,
                mode: 'markers+text',
                marker: {
                    size: 8 + cluster.totalQueries * 0.5,
                    color: cluster.successRate,
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: {
                        title: 'Success Rate'
                    }
                },
                text: cluster.name,
                textposition: 'top center',
                type: 'scatter3d',
                name: cluster.name
            }));
            
            const layout = {
                title: 'Cluster Distribution in 3D Space',
                scene: {
                    xaxis: { title: 'PC1' },
                    yaxis: { title: 'PC2' },
                    zaxis: { title: 'PC3' },
                    camera: {
                        eye: { x: 1.5, y: 1.5, z: 1.5 }
                    }
                },
                paper_bgcolor: '#000',
                plot_bgcolor: '#000',
                font: { color: '#00ff00' },
                showlegend: false
            };
            
            Plotly.newPlot('vector-3d-plot', data, layout, { responsive: true });
        }

        // Display prompt enhancements
        function displayEnhancements() {
            const container = document.getElementById('enhancementDetails');
            
            const enhancedClusters = dashboardData.clusters.filter(c => c.hasPromptEnhancement);
            
            if (enhancedClusters.length === 0) {
                container.innerHTML = '<p>No prompt enhancements available yet</p>';
                return;
            }
            
            container.innerHTML = enhancedClusters.map(cluster => `
                <div class="calculation-step">
                    <h4>${cluster.name}</h4>
                    <p>Enhancement applied after ${cluster.totalQueries} queries</p>
                    <p>Success rate: ${(cluster.successRate * 100).toFixed(1)}%</p>
                    <p>Length: ${cluster.promptEnhancementLength || 'N/A'} characters</p>
                </div>
            `).join('');
        }

        // Add log entry
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last 100 logs
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        // Clear logs
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            addLog('üßπ Logs cleared', 'system');
        }

        // Listen for real-time updates (if WebSocket is implemented)
        function connectWebSocket() {
            try {
                const ws = new WebSocket('ws://localhost:3001/ws/crowd-wisdom');
                
                ws.onopen = () => {
                    addLog('üîó Connected to real-time feed', 'system');
                };
                
                ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleRealtimeUpdate(data);
                    } catch (error) {
                        console.error('WebSocket message error:', error);
                    }
                };
                
                ws.onclose = () => {
                    addLog('üîå Disconnected from real-time feed', 'error');
                    // Retry connection after 5 seconds
                    setTimeout(connectWebSocket, 5000);
                };
                
            } catch (error) {
                console.log('WebSocket not available, using polling instead');
            }
        }

        // Handle real-time updates
        function handleRealtimeUpdate(data) {
            switch (data.type) {
                case 'query_processed':
                    addLog(`üì• New query processed: "${data.query}"`, 'embedding');
                    break;
                case 'cluster_assigned':
                    addLog(`üéØ Query assigned to cluster: ${data.clusterName}`, 'clustering');
                    break;
                case 'learning_triggered':
                    addLog(`üß† Learning triggered for cluster: ${data.clusterName}`, 'enhancement');
                    break;
            }
        }

        // Start WebSocket connection
        connectWebSocket();
    </script>
</body>
</html> 