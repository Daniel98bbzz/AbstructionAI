<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crowd Wisdom Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f7f9fc;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .flex-item {
            flex: 1;
            min-width: 300px;
        }
        button {
            background-color: #4a6fa5;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #3a5a80;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid #e2e8f0;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f8fafc;
        }
        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #edf2f7;
        }
        .stat-value {
            font-weight: bold;
            color: #4a6fa5;
        }
        .weight-input {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .weight-input label {
            width: 120px;
        }
        .weight-input input {
            width: 60px;
            padding: 5px;
            margin-right: 10px;
        }
        .weight-input span {
            flex-grow: 1;
            background-color: #e2e8f0;
            height: 10px;
            position: relative;
        }
        .weight-input span::after {
            content: '';
            position: absolute;
            height: 100%;
            background-color: #4a6fa5;
            left: 0;
            top: 0;
        }
        .template-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .tab-container {
            display: flex;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            background-color: #e2e8f0;
            border: none;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #4a6fa5;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .alert {
            padding: 15px;
            background-color: #f8d7da;
            color: #721c24;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
    </style>
</head>
<body>
    <h1>Crowd Wisdom Admin Dashboard</h1>
    
    <div id="alert" class="alert"></div>
    
    <div class="tab-container">
        <button class="tab-button active" data-tab="overview">Overview</button>
        <button class="tab-button" data-tab="templates">Templates</button>
        <button class="tab-button" data-tab="signals">Multi-Signal Config</button>
        <button class="tab-button" data-tab="ab-testing">A/B Testing</button>
        <button class="tab-button" data-tab="simulation">Simulation</button>
        <button class="tab-button" data-tab="migration">Migration</button>
    </div>
    
    <div id="overview" class="tab-content active">
        <div class="flex-container">
            <div class="flex-item card">
                <h2>System Overview</h2>
                <div id="stats-container">
                    <div class="stat-item">
                        <div>Total Templates</div>
                        <div class="stat-value" id="total-templates">Loading...</div>
                    </div>
                    <div class="stat-item">
                        <div>Average Efficacy Score</div>
                        <div class="stat-value" id="avg-efficacy">Loading...</div>
                    </div>
                    <div class="stat-item">
                        <div>Total Template Usage</div>
                        <div class="stat-value" id="total-usage">Loading...</div>
                    </div>
                    <div class="stat-item">
                        <div>Topics Covered</div>
                        <div class="stat-value" id="topics-count">Loading...</div>
                    </div>
                </div>
            </div>
            
            <div class="flex-item card">
                <h2>Quality Metrics Distribution</h2>
                <div class="chart-container">
                    <canvas id="quality-chart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Recent Template Usage</h2>
            <div id="recent-usage">
                <table>
                    <thead>
                        <tr>
                            <th>Template ID</th>
                            <th>Topic</th>
                            <th>Used At</th>
                            <th>Feedback</th>
                            <th>Selection Method</th>
                        </tr>
                    </thead>
                    <tbody id="usage-table-body">
                        <tr>
                            <td colspan="5" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="templates" class="tab-content">
        <div class="card">
            <h2>Template Directory</h2>
            <div class="template-list">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Topic</th>
                            <th>Efficacy</th>
                            <th>Comp. Score</th>
                            <th>Follow-up Rate</th>
                            <th>Confusion Score</th>
                            <th>Confidence</th>
                            <th>Usage</th>
                        </tr>
                    </thead>
                    <tbody id="templates-table-body">
                        <tr>
                            <td colspan="8" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="signals" class="tab-content">
        <div class="card">
            <h2>Multi-Signal Configuration</h2>
            <p>Configure weights for the composite quality score calculation. Sum should equal 1.0.</p>
            
            <div class="weight-input">
                <label for="efficacy-weight">Efficacy Weight:</label>
                <input type="number" id="efficacy-weight" min="0" max="1" step="0.05" value="0.35">
                <span id="efficacy-bar" style="--weight: 0.35"></span>
            </div>
            
            <div class="weight-input">
                <label for="followup-weight">Follow-up Weight:</label>
                <input type="number" id="followup-weight" min="0" max="1" step="0.05" value="0.20">
                <span id="followup-bar" style="--weight: 0.20"></span>
            </div>
            
            <div class="weight-input">
                <label for="confusion-weight">Confusion Weight:</label>
                <input type="number" id="confusion-weight" min="0" max="1" step="0.05" value="0.20">
                <span id="confusion-bar" style="--weight: 0.20"></span>
            </div>
            
            <div class="weight-input">
                <label for="confidence-weight">Confidence Weight:</label>
                <input type="number" id="confidence-weight" min="0" max="1" step="0.05" value="0.15">
                <span id="confidence-bar" style="--weight: 0.15"></span>
            </div>
            
            <div class="weight-input">
                <label for="components-weight">Components Weight:</label>
                <input type="number" id="components-weight" min="0" max="1" step="0.05" value="0.10">
                <span id="components-bar" style="--weight: 0.10"></span>
            </div>
            
            <div style="margin-top: 20px;">
                <span id="weight-sum">Total: 1.00</span>
                <button id="recalculate-btn" style="margin-left: 20px;">Recalculate Scores</button>
            </div>
        </div>
        
        <div class="card">
            <h2>Signal Correlation</h2>
            <div class="chart-container">
                <canvas id="correlation-chart"></canvas>
            </div>
        </div>
    </div>
    
    <div id="ab-testing" class="tab-content">
        <div class="card">
            <h2>A/B Testing Results</h2>
            <div class="flex-container">
                <div class="flex-item">
                    <h3>Efficacy Score (Traditional)</h3>
                    <div id="efficacy-stats">
                        <div class="stat-item">
                            <div>Usage Count</div>
                            <div class="stat-value" id="efficacy-count">Loading...</div>
                        </div>
                        <div class="stat-item">
                            <div>Average Rating</div>
                            <div class="stat-value" id="efficacy-rating">Loading...</div>
                        </div>
                        <div class="stat-item">
                            <div>Follow-up Rate</div>
                            <div class="stat-value" id="efficacy-followup">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <div class="flex-item">
                    <h3>Composite Score (Multi-Signal)</h3>
                    <div id="composite-stats">
                        <div class="stat-item">
                            <div>Usage Count</div>
                            <div class="stat-value" id="composite-count">Loading...</div>
                        </div>
                        <div class="stat-item">
                            <div>Average Rating</div>
                            <div class="stat-value" id="composite-rating">Loading...</div>
                        </div>
                        <div class="stat-item">
                            <div>Follow-up Rate</div>
                            <div class="stat-value" id="composite-followup">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chart-container" style="margin-top: 20px;">
                <canvas id="ab-chart"></canvas>
            </div>
        </div>
    </div>
    
    <div id="simulation" class="tab-content">
        <div class="card">
            <h2>Simulate Template Selection</h2>
            <p>Test how templates would be selected with different signals and weights.</p>
            
            <div class="form-group">
                <label for="sim-topic">Topic:</label>
                <select id="sim-topic">
                    <option value="computer_science">Computer Science</option>
                    <option value="mathematics">Mathematics</option>
                    <option value="physics">Physics</option>
                    <option value="chemistry">Chemistry</option>
                    <option value="biology">Biology</option>
                    <option value="engineering">Engineering</option>
                    <option value="general">General</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Selection Method:</label>
                <div>
                    <input type="radio" id="sim-composite" name="sim-method" value="composite" checked>
                    <label for="sim-composite">Composite Score</label>
                    
                    <input type="radio" id="sim-efficacy" name="sim-method" value="efficacy">
                    <label for="sim-efficacy">Efficacy Score Only</label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="sim-exploration">Exploration Rate:</label>
                <input type="range" id="sim-exploration" min="0" max="0.5" step="0.05" value="0.1">
                <span id="sim-exploration-value">0.1</span>
            </div>
            
            <div class="form-group">
                <label>Custom Weights (for Composite Score):</label>
                <div class="weight-input">
                    <label for="sim-efficacy-weight">Efficacy:</label>
                    <input type="number" id="sim-efficacy-weight" min="0" max="1" step="0.05" value="0.35">
                </div>
                
                <div class="weight-input">
                    <label for="sim-followup-weight">Follow-up:</label>
                    <input type="number" id="sim-followup-weight" min="0" max="1" step="0.05" value="0.20">
                </div>
                
                <div class="weight-input">
                    <label for="sim-confusion-weight">Confusion:</label>
                    <input type="number" id="sim-confusion-weight" min="0" max="1" step="0.05" value="0.20">
                </div>
                
                <div class="weight-input">
                    <label for="sim-confidence-weight">Confidence:</label>
                    <input type="number" id="sim-confidence-weight" min="0" max="1" step="0.05" value="0.15">
                </div>
                
                <div class="weight-input">
                    <label for="sim-components-weight">Components:</label>
                    <input type="number" id="sim-components-weight" min="0" max="1" step="0.05" value="0.10">
                </div>
                
                <div style="margin-top: 10px;">
                    <span id="sim-weight-sum">Total: 1.00</span>
                </div>
            </div>
            
            <button id="sim-run-btn">Run Simulation</button>
            
            <div id="sim-results" style="margin-top: 20px; display: none;">
                <h3>Simulation Results</h3>
                <div id="sim-selected-template" class="card" style="background-color: #e8f4f8; margin-bottom: 20px;">
                    <h4>Selected Template</h4>
                    <div id="sim-selected-content"></div>
                </div>
                
                <h4>Available Templates</h4>
                <div id="sim-available-templates"></div>
            </div>
        </div>
    </div>
    
    <div id="migration" class="tab-content">
        <div class="card">
            <h2>Run Multi-Signal Migration</h2>
            <p>Set up database schema for multi-signal evaluation. This will:</p>
            <ul>
                <li>Add follow_up_rate, confusion_score, confidence_score, and component_rating fields to templates</li>
                <li>Add had_follow_up field to template usage records</li>
                <li>Create the template_component_feedback table</li>
                <li>Calculate initial composite quality scores</li>
            </ul>
            
            <div class="form-group">
                <label for="migration-admin-key">Admin Key:</label>
                <input type="password" id="migration-admin-key" placeholder="Enter admin key">
            </div>
            
            <button id="run-migration-btn">Run Migration</button>
        </div>
    </div>
    
    <script>
        // Tab switching logic
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // Set active button
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');
                
                // Show active content
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });
        
        // Function to show alert messages
        function showAlert(message, isSuccess = false) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.style.display = 'block';
            
            if (isSuccess) {
                alert.classList.add('success');
            } else {
                alert.classList.remove('success');
            }
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        // Weight bar visualization update
        function updateWeightBars() {
            const weights = {
                efficacy: parseFloat(document.getElementById('efficacy-weight').value),
                followup: parseFloat(document.getElementById('followup-weight').value),
                confusion: parseFloat(document.getElementById('confusion-weight').value),
                confidence: parseFloat(document.getElementById('confidence-weight').value),
                components: parseFloat(document.getElementById('components-weight').value)
            };
            
            const sum = Object.values(weights).reduce((total, weight) => total + weight, 0);
            document.getElementById('weight-sum').textContent = `Total: ${sum.toFixed(2)}`;
            
            if (Math.abs(sum - 1) > 0.01) {
                document.getElementById('weight-sum').style.color = 'red';
            } else {
                document.getElementById('weight-sum').style.color = 'green';
            }
            
            // Update bars
            document.getElementById('efficacy-bar').style.setProperty('--weight', weights.efficacy);
            document.getElementById('followup-bar').style.setProperty('--weight', weights.followup);
            document.getElementById('confusion-bar').style.setProperty('--weight', weights.confusion);
            document.getElementById('confidence-bar').style.setProperty('--weight', weights.confidence);
            document.getElementById('components-bar').style.setProperty('--weight', weights.components);
            
            document.querySelectorAll('.weight-input span').forEach(span => {
                const weight = parseFloat(span.style.getPropertyValue('--weight'));
                span.style.setProperty('width', `${weight * 100}%`);
            });
        }
        
        // Add event listeners to weight inputs
        document.querySelectorAll('.weight-input input').forEach(input => {
            input.addEventListener('input', updateWeightBars);
        });
        
        // Load metrics and update dashboard
        async function loadOverviewMetrics() {
            try {
                const response = await fetch('/api/admin/crowd-wisdom/metrics');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-templates').textContent = data.totalTemplates;
                    document.getElementById('avg-efficacy').textContent = data.avgEfficacy.toFixed(2);
                    document.getElementById('total-usage').textContent = data.totalUsage;
                    document.getElementById('topics-count').textContent = data.topicsCount;
                }
            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }
        
        // Load recent usage data
        async function loadRecentUsage() {
            try {
                const response = await fetch('/api/admin/crowd-wisdom/usage');
                const data = await response.json();
                
                if (data.success) {
                    const tableBody = document.getElementById('usage-table-body');
                    tableBody.innerHTML = '';
                    
                    data.usage.slice(0, 10).forEach(usage => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${usage.template_id}</td>
                            <td>-</td>
                            <td>${new Date(usage.created_at).toLocaleString()}</td>
                            <td>${usage.feedback_score || '-'}</td>
                            <td>${usage.selection_method || 'efficacy'}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading usage data:', error);
            }
        }
        
        // Load templates data
        async function loadTemplates() {
            try {
                const response = await fetch('/api/admin/crowd-wisdom/templates');
                const data = await response.json();
                
                if (data.success) {
                    const tableBody = document.getElementById('templates-table-body');
                    tableBody.innerHTML = '';
                    
                    // Populate topic filter for simulation
                    const topics = new Set();
                    
                    data.templates.forEach(template => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${template.id}</td>
                            <td>${template.topic}</td>
                            <td>${template.efficacy_score ? template.efficacy_score.toFixed(2) : '-'}</td>
                            <td>${template.composite_quality_score ? template.composite_quality_score.toFixed(2) : '-'}</td>
                            <td>${template.follow_up_rate ? (template.follow_up_rate * 100).toFixed(1) + '%' : '-'}</td>
                            <td>${template.confusion_score ? template.confusion_score.toFixed(2) : '-'}</td>
                            <td>${template.confidence_score ? template.confidence_score.toFixed(2) : '-'}</td>
                            <td>${template.usage_count || 0}</td>
                        `;
                        tableBody.appendChild(row);
                        
                        // Collect unique topics for simulation dropdown
                        if (template.topic) {
                            topics.add(template.topic);
                        }
                    });
                    
                    // Update simulation topic dropdown with actual topics from database
                    const simTopicSelect = document.getElementById('sim-topic');
                    const currentTopic = simTopicSelect.value; // Keep current selection if possible
                    
                    // Clear current options
                    simTopicSelect.innerHTML = '';
                    
                    // Add topics sorted alphabetically
                    Array.from(topics).sort().forEach(topic => {
                        const option = document.createElement('option');
                        option.value = topic;
                        option.textContent = topic.charAt(0).toUpperCase() + topic.slice(1).replace(/_/g, ' ');
                        simTopicSelect.appendChild(option);
                    });
                    
                    // Try to restore previous selection
                    if (topics.has(currentTopic)) {
                        simTopicSelect.value = currentTopic;
                    }
                    
                    // Initialize quality metrics chart
                    const templates = data.templates;
                    const ctx = document.getElementById('quality-chart').getContext('2d');
                    
                    const efficacyScores = templates.map(t => t.efficacy_score || 0);
                    const compositeScores = templates.map(t => t.composite_quality_score || 0);
                    const templateIds = templates.map(t => t.id);
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: templateIds,
                            datasets: [
                                {
                                    label: 'Efficacy Score',
                                    data: efficacyScores,
                                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Composite Score',
                                    data: compositeScores,
                                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    
                    // Initialize correlation chart
                    const correlationCtx = document.getElementById('correlation-chart').getContext('2d');
                    
                    // Filter out templates with missing data
                    const completeTemplates = templates.filter(t => 
                        t.efficacy_score !== null && 
                        t.follow_up_rate !== null && 
                        t.confusion_score !== null &&
                        t.confidence_score !== null
                    );
                    
                    // Prepare data for scatter plot
                    const correlationData = completeTemplates.map(t => ({
                        x: t.efficacy_score || 0,
                        y: 1 - (t.follow_up_rate || 0), // Invert so higher is better
                        r: Math.max(3, (t.usage_count || 1) / 2), // Size based on usage count
                        template: t.id
                    }));
                    
                    new Chart(correlationCtx, {
                        type: 'bubble',
                        data: {
                            datasets: [{
                                label: 'Efficacy vs. Follow-up Rate (inverted)',
                                data: correlationData,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Efficacy Score'
                                    },
                                    min: 0,
                                    max: 5
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Follow-up Rate (inverted)'
                                    },
                                    min: 0,
                                    max: 1
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `Template: ${context.raw.template}, Efficacy: ${context.raw.x.toFixed(2)}, Follow-up: ${(1 - context.raw.y).toFixed(2)}`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    showStatus('Templates loaded successfully', 'success');
                }
            } catch (error) {
                console.error('Error loading templates:', error);
                showStatus('Failed to load templates: ' + error.message, 'error');
            }
        }
        
        // Show status message
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }
        
        // Update exploration rate display
        document.getElementById('sim-exploration').addEventListener('input', function() {
            document.getElementById('sim-exploration-value').textContent = this.value;
        });
        
        // Update simulation weight sum
        function updateSimWeightSum() {
            const weights = {
                efficacy: parseFloat(document.getElementById('sim-efficacy-weight').value),
                followup: parseFloat(document.getElementById('sim-followup-weight').value),
                confusion: parseFloat(document.getElementById('sim-confusion-weight').value),
                confidence: parseFloat(document.getElementById('sim-confidence-weight').value),
                components: parseFloat(document.getElementById('sim-components-weight').value)
            };
            
            const sum = Object.values(weights).reduce((total, weight) => total + weight, 0);
            document.getElementById('sim-weight-sum').textContent = `Total: ${sum.toFixed(2)}`;
            
            if (Math.abs(sum - 1) > 0.01) {
                document.getElementById('sim-weight-sum').style.color = 'red';
            } else {
                document.getElementById('sim-weight-sum').style.color = 'green';
            }
        }
        
        // Add event listeners to simulation weight inputs
        document.querySelectorAll('#simulation .weight-input input').forEach(input => {
            input.addEventListener('input', updateSimWeightSum);
        });
        
        // Run simulation
        document.getElementById('sim-run-btn').addEventListener('click', async function() {
            const topic = document.getElementById('sim-topic').value;
            const useCompositeScore = document.getElementById('sim-composite').checked;
            const explorationRate = parseFloat(document.getElementById('sim-exploration').value);
            
            // Get weights
            const weights = {
                efficacy: parseFloat(document.getElementById('sim-efficacy-weight').value),
                followUp: parseFloat(document.getElementById('sim-followup-weight').value),
                confusion: parseFloat(document.getElementById('sim-confusion-weight').value),
                confidence: parseFloat(document.getElementById('sim-confidence-weight').value),
                components: parseFloat(document.getElementById('sim-components-weight').value)
            };
            
            const sum = Object.values(weights).reduce((total, weight) => total + weight, 0);
            
            if (useCompositeScore && Math.abs(sum - 1) > 0.01) {
                showAlert('Weight sum must equal 1.0 for simulation with composite score.');
                return;
            }
            
            try {
                document.getElementById('sim-run-btn').textContent = 'Running...';
                document.getElementById('sim-run-btn').disabled = true;
                
                const response = await fetch('/api/admin/crowd-wisdom/simulate-selection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        adminKey: 'crowd-wisdom-admin',
                        topic,
                        weights: useCompositeScore ? weights : null,
                        useCompositeScore,
                        explorationRate
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Display results
                    document.getElementById('sim-results').style.display = 'block';
                    
                    // Selected template
                    if (data.selected_template) {
                        const selectedContent = document.getElementById('sim-selected-content');
                        selectedContent.innerHTML = `
                            <p><strong>ID:</strong> ${data.selected_template.id}</p>
                            <p><strong>Topic:</strong> ${data.selected_template.topic}</p>
                            <p><strong>Efficacy Score:</strong> ${data.selected_template.efficacy_score?.toFixed(2) || 'N/A'}</p>
                            <p><strong>Composite Score:</strong> ${data.selected_template.composite_quality_score?.toFixed(2) || 'N/A'}</p>
                            <p><strong>Follow-up Rate:</strong> ${data.selected_template.follow_up_rate ? (data.selected_template.follow_up_rate * 100).toFixed(1) + '%' : 'N/A'}</p>
                            <p><strong>Confusion Score:</strong> ${data.selected_template.confusion_score?.toFixed(2) || 'N/A'}</p>
                            <p><strong>Usage Count:</strong> ${data.selected_template.usage_count || '0'}</p>
                            <p><strong>Selection Method:</strong> ${data.selection_method}</p>
                            <p><strong>Exploration Rate:</strong> ${data.exploration_rate}</p>
                        `;
                    } else {
                        document.getElementById('sim-selected-content').innerHTML = '<p>No template was selected for this topic.</p>';
                    }
                    
                    // Available templates
                    const availableTemplates = document.getElementById('sim-available-templates');
                    availableTemplates.innerHTML = '';
                    
                    if (data.available_templates && data.available_templates.length > 0) {
                        const table = document.createElement('table');
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Efficacy</th>
                                    <th>Composite</th>
                                    <th>Follow-up Rate</th>
                                    <th>Confusion</th>
                                    <th>Confidence</th>
                                    <th>Usage</th>
                                    <th>Selected</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;
                        
                        const tbody = table.querySelector('tbody');
                        
                        data.available_templates.forEach(template => {
                            const isSelected = data.selected_template && template.id === data.selected_template.id;
                            const row = document.createElement('tr');
                            
                            if (isSelected) {
                                row.style.backgroundColor = '#d4edda';
                                row.style.fontWeight = 'bold';
                            }
                            
                            row.innerHTML = `
                                <td>${template.id}</td>
                                <td>${template.efficacy_score?.toFixed(2) || 'N/A'}</td>
                                <td>${template.composite_quality_score?.toFixed(2) || 'N/A'}</td>
                                <td>${template.follow_up_rate ? (template.follow_up_rate * 100).toFixed(1) + '%' : 'N/A'}</td>
                                <td>${template.confusion_score?.toFixed(2) || 'N/A'}</td>
                                <td>${template.confidence_score?.toFixed(2) || 'N/A'}</td>
                                <td>${template.usage_count || '0'}</td>
                                <td>${isSelected ? '✓' : ''}</td>
                            `;
                            
                            tbody.appendChild(row);
                        });
                        
                        availableTemplates.appendChild(table);
                    } else {
                        availableTemplates.innerHTML = '<p>No templates found for this topic.</p>';
                    }
                    
                    showAlert('Simulation completed successfully', true);
                } else {
                    showAlert('Simulation failed: ' + data.message);
                }
            } catch (error) {
                console.error('Error running simulation:', error);
                showAlert('Error: ' + error.message);
            } finally {
                document.getElementById('sim-run-btn').textContent = 'Run Simulation';
                document.getElementById('sim-run-btn').disabled = false;
            }
        });
        
        // Run multi-signal migration
        document.getElementById('run-migration-btn').addEventListener('click', async function() {
            const adminKey = document.getElementById('migration-admin-key').value;
            
            if (!adminKey) {
                showAlert('Admin key is required');
                return;
            }
            
            try {
                document.getElementById('run-migration-btn').textContent = 'Running...';
                document.getElementById('run-migration-btn').disabled = true;
                
                const response = await fetch('/api/admin/run-multi-signal-migration', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        adminKey: adminKey
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('migration-admin-key').value = '';
                    showAlert(`Migration completed successfully! Updated ${data.templates_updated} templates.`, true);
                    
                    // Reload data
                    loadTemplates();
                    loadOverviewMetrics();
                } else {
                    showAlert('Migration failed: ' + data.message);
                }
            } catch (error) {
                console.error('Error running migration:', error);
                showAlert('Error: ' + error.message);
            } finally {
                document.getElementById('run-migration-btn').textContent = 'Run Migration';
                document.getElementById('run-migration-btn').disabled = false;
            }
        });
        
        // Initialize the dashboard
        function initDashboard() {
            loadOverviewMetrics();
            loadRecentUsage();
            loadTemplates();
            loadABTestingData();
            updateWeightBars();
            updateSimWeightSum(); // Initialize simulation weights display
        }
        
        // Call init on page load
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html> 